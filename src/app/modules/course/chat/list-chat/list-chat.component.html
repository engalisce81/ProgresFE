<div class="chat-wrapper">
  <header class="chat-header">
    <div class="user-info">
      <div class="avatar">
        <img *ngIf="messages.length > 0 && messages[0].logoUrl" [src]="messages[0].logoUrl" class="user-img">
        <div *ngIf="!messages.length || !messages[0].logoUrl" class="avatar-placeholder">
          {{ receiverId?.substring(0, 2).toUpperCase() || 'CH' }}
        </div>
      </div>
      <div class="details">
        <h3>Chat Room</h3>
        <span class="status">
          <span class="status-dot"></span>
          Online
        </span>
      </div>
    </div>
  </header>

  <div class="messages-container" #scrollContainer (scroll)="onScroll()">
    <!-- Loader عند التحميل لأول مرة -->
    <div *ngIf="loading && !isLoadingMore && messages.length === 0" class="loader-spinner">
      <div class="spinner"></div>
      <span>Loading messages...</span>
    </div>

    <!-- زر تحميل المزيد -->
    <div class="load-more-container" *ngIf="hasMoreMessages">
      <button 
        class="load-more-btn" 
        (click)="loadMoreMessages()" 
        [disabled]="isLoadingMore">
        <i class="fa fa-history" *ngIf="!isLoadingMore"></i>
        <span>{{ isLoadingMore ? 'Loading...' : 'Load More Messages' }}</span>
      </button>
    </div>

    <!-- الرسائل -->
    <div *ngFor="let msg of messages" 
         [ngClass]="{'msg-me': msg.senderId === currentUserId, 'msg-them': msg.senderId !== currentUserId}" 
         class="message-wrapper">
      
      <div class="avatar-wrapper" *ngIf="msg.senderId !== currentUserId">
        <img [src]="msg.logoUrl" 
             class="msg-avatar"
             >
      </div>
      
      <div class="message-content">
        <div class="message-bubble">
          <div class="msg-actions"  >
            <button *ngIf="canEditMessage(msg)" (click)="startEdit(msg)" class="edit-btn" title="Edit">
              <i class="fa fa-pen"></i>
            </button>
            <button *ngIf="canDeleteMessage(msg)" (click)="deleteMsg(msg.id)" class="delete-btn" title="Delete">
              <i class="fa fa-trash"></i>
            </button>
          </div>

          <span class="sender-name" *ngIf="msg.senderId !== currentUserId">
            {{ msg.senderName || 'User' }}
          </span>
          
          <p class="message-text">{{ msg.message }}</p>
          
          <div class="meta">
            <span class="edited-mark" *ngIf="msg.isEdited">(edited)</span>
            <span class="time">{{ msg.creationTime | date:'shortTime' }}</span>
            <i class="fa fa-check-double read-icon" *ngIf="msg.senderId === currentUserId"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Loader عند التحميل أثناء المحادثة -->
    <div *ngIf="isLoadingMore" class="loading-more">
      <div class="mini-spinner"></div>
    </div>
  </div>

  <footer class="chat-footer">
    <div class="edit-banner" *ngIf="editingMessageId">
      <div class="edit-info">
        <i class="fa fa-edit"></i>
        <span>Editing message</span>
      </div>
      <button (click)="cancelEdit()" class="cancel-edit-btn">
        <i class="fa fa-times"></i>
        Cancel
      </button>
    </div>

    <div class="input-area">
      <input type="text" 
             [(ngModel)]="newMessage" 
             (keyup.enter)="send()" 
             [placeholder]="editingMessageId ? 'Update your message...' : 'Type a message...'"
             class="message-input">
      
      <button class="send-btn" 
              (click)="send()" 
              [disabled]="!newMessage.trim() || sending"
              [class.editing]="editingMessageId">
        <div class="send-btn-content">
          <i class="fa" 
             [ngClass]="editingMessageId ? 'fa-check' : 'fa-paper-plane'" 
             *ngIf="!sending"></i>
          <div class="spinner-small" *ngIf="sending"></div>
        </div>
      </button>
    </div>
  </footer>
</div>