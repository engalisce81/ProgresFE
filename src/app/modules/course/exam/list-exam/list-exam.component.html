<div class="list-container">
  <!-- تبويبات التنقل -->
  <div class="tabs-header">
    <div class="tabs">
      <button class="tab-btn" [class.active]="activeTab === 'exams'" (click)="switchTab('exams')">
        <i class="bi bi-journal-text"></i> Exams
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'questions'" [disabled]="!selectedExamForQuestions">
        <i class="bi bi-patch-question"></i> Manage Questions
        @if(selectedExamForQuestions) {
        <span class="exam-badge">{{selectedExamForQuestions.name}}</span>
        }
      </button>
    </div>

    @if(activeTab === 'exams') {
    <div class="toolbar">
      <div class="search-wrapper">
        <i class="bi bi-search search-icon"></i>
        <input type="text" [(ngModel)]="search" (keyup.enter)="loadExams()" placeholder="Search exams..."
          class="search-input-modern">
      </div>
      <button class="btn-create-modern" (click)="openCreateForm()">
        <i class="bi bi-plus-lg"></i> New Exam
      </button>
    </div>
    }
  </div>

  <!-- محتوى التبويب: الامتحانات -->
  @if(activeTab === 'exams') {
  @if(loading && !showDeleteConfirm) {
  <div class="loading-overlay">
    <div class="spinner-modern"></div>
  </div>
  } @else {
  <div class="cards-grid">
    @for(exam of exams; track exam.id) {
    <div class="exam-card">
      <div class="card-status" [class.active]="exam.isActive">
        <span class="dot"></span> {{ exam.isActive ? 'Active' : 'Hidden' }}
      </div>

      <div class="card-content">
        <h3 class="exam-title">{{ exam.name }}</h3>
        <div class="exam-info">
          <span><i class="bi bi-stopwatch"></i> {{ exam.timeExam }}m</span>
          <span><i class="bi bi-star"></i> {{ exam.score }} pts</span>
        </div>
      </div>

      <div class="card-actions">
        <button [routerLink]="[exam.id,'questions']" class="act-btn questions" title="View Questions">
          <i class="bi bi-eye"></i> </button>
          <button [routerLink]="[exam.id,'students']" class="act-btn questions" title="View Students">
          <i class="bi-mortarboard"></i> </button>

        <button (click)="switchTab('questions', exam)" class="act-btn questions" title="Manage Bank">
          <i class="bi bi-question-circle"></i> </button>

        <button (click)="openEditForm(exam)" class="act-btn edit" title="Edit Exam">
          <i class="bi bi-pencil-square"></i> </button>

        <button (click)="confirmDelete(exam)" class="act-btn delete" title="Delete Exam">
          <i class="bi bi-trash3-fill"></i> </button>
      </div>
    </div>
    }
  </div>

  @if(exams.length === 0) {
  <div class="empty-state">
    <i class="bi bi-journal-x"></i>
    <p>No exams linked to this course yet.</p>
  </div>
  }
  }
  }

  <!-- محتوى التبويب: إدارة الأسئلة -->
  @if(activeTab === 'questions') {
  <div class="questions-management-container">
    <div class="questions-header">
      <button class="btn-back" (click)="switchTab('exams')">
        <i class="bi bi-arrow-left"></i> Back to Exams
      </button>
      <h3 class="exam-title">Manage Questions for: {{selectedExamForQuestions?.name}}</h3>
    </div>

    <!-- Select Banks -->
    <div class="form-section">
      <h4>Select Question Banks</h4>
      <div class="bank-selection">
        @for (bank of banks; track $index) {
        <div class="bank-checkbox">
          <input type="checkbox" [id]="bank.id" [value]="bank.id" (change)="onBankChecked($event, bank.id!)"
            [checked]="selectedBankIds.includes(bank.id!)" />
          <label [for]="bank.id">
            {{ bank.name }}
          </label>
        </div>
        }
      </div>

      <button class="btn-load-questions" (click)="loadQuestionsForExam()" [disabled]="selectedBankIds.length === 0">
        <i class="bi bi-arrow-down-circle"></i> Load Questions
      </button>
    </div>

    <!-- Questions List -->
    @if(questions.length > 0) {
    <div class="questions-list-container">
      <div class="questions-header">
        <h4>Loaded Questions ({{questions.length}})</h4>
        <button class="btn-add-selected" [disabled]=" loadingQuestions" (click)="addSelectedQuestions()">
          @if(loadingQuestions) {
          <span class="spinner-mini"></span> Adding...
          } @else {
          <i class="bi bi-plus-circle"></i> Add Selected Questions
          }
        </button>
      </div>

      <div class="questions-grid">
        @for (question of questions; track $index) {
        <div class="question-card" [class.selected]="question.isSelected">
          <div class="question-header">
            <input type="checkbox" [(ngModel)]="question.isSelected" />
            <span class="question-type">{{question.questionType}}</span>
          </div>
          <div class="question-body">
              @if(question.logoUrl) {
              <div class="question-image-wrapper">
                <img [src]="question.logoUrl" alt="Question Image" class="question-img-preview">
              </div>
              }
              <h5>{{question.tittle}}</h5>
              @if(question.questionAnswers && question.questionAnswers.length > 0) {
              <ul class="answers-list">
                @for (ans of question.questionAnswers; track $index) {
                <li [class.correct]="ans.isSelected">{{ans.answer}}</li>
                }
              </ul>
              }
            </div>
          </div>
          }
        </div>
      </div>
      }

      @if(loadingQuestions) {
      <div class="loading-overlay">
        <div class="spinner-modern"></div>
      </div>
      }
    </div>
    }

    <!-- مودال إنشاء/تعديل الامتحان -->
    @if(showForm) {
    <div class="modal-overlay">
      <div class="modal-content-card">
        <div class="form-header">
          <h3>
            <i class="bi" [ngClass]="isEditMode ? 'bi-pencil-square' : 'bi-journal-plus'"></i>
            {{ isEditMode ? 'Update Exam' : 'Create New Exam' }}
          </h3>
          <button class="btn-close-form" (click)="closeForm()"><i class="bi bi-x-lg"></i></button>
        </div>

        <form [formGroup]="examForm" (ngSubmit)="submit()" class="modern-vertical-form">
          <div class="form-group">
            <label>Exam Name *</label>
            <input type="text" formControlName="name" class="form-control" placeholder="e.g. Monthly Assessment">
          </div>

          <div class="form-row-dual">
            <div class="form-group">
              <label>Duration (Minutes)</label>
              <input type="number" formControlName="timeExam" class="form-control">
            </div>
            <div class="form-group">
              <label>Total Score</label>
              <input type="number" formControlName="score" class="form-control">
            </div>
          </div>

          <div class="form-group checkbox-align">
            <label class="switch-label">
              <input type="checkbox" formControlName="isActive">
              <span>Show to Students (Active)</span>
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeForm()">Cancel</button>
            <button type="submit" class="btn-confirm" [disabled]="examForm.invalid || submitting">
              {{ submitting ? 'Processing...' : 'Save Settings' }}
            </button>
          </div>
        </form>
      </div>
    </div>
    }

    <!-- مودال تأكيد الحذف -->
    @if(showDeleteConfirm) {
    <div class="modal-overlay">
      <div class="delete-modal">
        <div class="warning-ring"><i class="bi bi-exclamation-triangle"></i></div>
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete <strong>{{ examToDelete?.name }}</strong>?</p>
        <div class="modal-btns">
          <button class="btn-no" (click)="cancelDelete()">Back</button>
          <button class="btn-yes" (click)="deleteExam()">Delete Forever</button>
        </div>
      </div>
    </div>
    }
  </div>