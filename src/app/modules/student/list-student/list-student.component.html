<div class="list-container">

 @if (showFormModal) {
  <div class="modal-overlay">
    <div class="form-card" style="max-width: 600px;">
      <h3>{{ isEditMode ? 'Edit Student' : 'Create New Student' }}</h3>
      <form [formGroup]="studentForm" (ngSubmit)="submitForm()">
        <div class="row-grid">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" formControlName="fullName" placeholder="Enter full name (e.g. Ahmed Ali)" class="form-control">
          </div>
          <div class="form-group">
            <label>Username *</label>
            <input type="text" formControlName="userName" placeholder="Enter unique username" class="form-control">
          </div>
        </div>

        <div class="row-grid">
          <div class="form-group">
            <label>Phone Number *</label>
            <input type="text" formControlName="phoneNumber" placeholder="e.g. 01xxxxxxxxx" class="form-control">
          </div>
          <div class="form-group">
            <label>Gender *</label>
            <select formControlName="gender" class="form-control">
              <option value="" disabled selected>-- Choose Gender --</option>
              <option [value]="true">Male</option>
              <option [value]="false">Female</option>
            </select>
          </div>
        </div>

        @if (!isEditMode) {
        <div class="form-group">
          <label>Password *</label>
          <input type="password" formControlName="password" placeholder="Create a strong password" class="form-control">
        </div>
        }

        <div class="form-group">
          <label>University *</label>
          <select formControlName="universityId" class="form-control">
            <option value="" disabled selected>-- Select University --</option>
            @for (u of universities; track u.id) { <option [value]="u.id">{{u.name}}</option> }
          </select>
        </div>

        <div class="row-grid">
          <div class="form-group">
            <label>College *</label>
            <select formControlName="collegeId" class="form-control">
              <option value="" disabled selected>-- Select College --</option>
              @for (c of colleges; track c.id) { <option [value]="c.id">{{c.name}}</option> }
            </select>
          </div>
          <div class="form-group">
            <label>Grade Level *</label>
            <select formControlName="gradeLevelId" class="form-control">
              <option value="" disabled selected>-- Select Grade Level --</option>
              @for (g of gradeLevels; track g.id) { <option [value]="g.id">{{g.name}}</option> }
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeFormModal()">Cancel</button>
          <button type="submit" class="btn-confirm" [disabled]="studentForm.invalid || loading">Save Student</button>
        </div>
      </form>
    </div>
  </div>
  }
  @if (showPasswordModal) {
  <div class="modal-overlay">
    <div class="form-card">
      <h3>Reset Password</h3>
      <p class="text-muted">For: <b>{{selectedStudent?.fullName}}</b></p>
      <div class="form-group">
        <label>New Password</label>
        <input type="password" [(ngModel)]="newPassword"  placeholder="Enter new password" class="form-control">
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" [(ngModel)]="confirmPassword" placeholder="Repeat new password" class="form-control">
      </div>
      @if (passwordError) { <small class="text-danger">{{passwordError}}</small> }
      <div class="modal-actions">
        <button class="btn-cancel" (click)="showPasswordModal = false">Cancel</button>
        <button class="btn-confirm" (click)="resetPassword()">Reset Now</button>
      </div>
    </div>
  </div>
  }

  @if (showAssignCoursesModal) {
    <div class="modal-overlay">
      <div class="form-card" style="max-width: 500px;">
        <h3>Assign Courses</h3>
        <div class="course-list-scroll" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
          @for (course of courses; track course.courseId) {
            <div class="checkbox-group" style="padding: 10px; border-bottom: 1px solid var(--surface-variant);">
              <input type="checkbox" [(ngModel)]="course.isSelect" [id]="course.courseId">
              <label [for]="course.courseId" style="margin-left: 10px;">{{course.courseName}}</label>
            </div>
          }
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" (click)="showAssignCoursesModal = false">Cancel</button>
          <button class="btn-confirm" (click)="assignCourses()">Assign Selected</button>
        </div>
      </div>
    </div>
  }

  <div class="toolbar">
    <div class="search-wrapper">
      <i class="bi bi-search search-icon"></i>
      <input type="text" [(ngModel)]="search" (input)="onSearchChange()" placeholder="Search students..." class="search-input-modern" />
    </div>
    <button (click)="openCreateModal()" class="btn-create-modern">
      <i class="bi bi-person-plus"></i> <span>Add Student</span>
    </button>
  </div>

  <div class="cards-grid">
    @for (student of students; track student.id) {
    <div class="course-card">
      <div class="card-header">
        <div class="chapter-icon-placeholder">
          <i class="bi" [ngClass]="student.gender === 1 ? 'bi-person-standing' : 'bi-person-standing-dress'"></i>
        </div>
        <div class="dropdown-actions">
          <button class="dots-btn" (click)="$event.stopPropagation(); student['showMenu'] = !student['showMenu']">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
          @if (student['showMenu']) {
          <div class="actions-menu" (mouseleave)="student['showMenu'] = false">
            <button (click)="openEditModal(student)"><i class="bi bi-pencil"></i> Edit</button>
            <button (click)="openPasswordModal(student)"><i class="bi bi-key"></i> Password</button>
            <button (click)="openAssignCoursesModal(student)"><i class="bi bi-book"></i> Courses</button>
            <button class="text-danger" (click)="confirmDelete(student)"><i class="bi bi-trash"></i> Delete</button>
          </div>
          }
        </div>
      </div>
      <div class="card-body">
        <div class="badge-group">
          <span class="custom-badge">{{ student.userName }}</span>
        </div>
        <h3 class="course-name">{{ student.fullName }}</h3>
        <p class="course-title">{{ student.collegeName }} - {{ student.gradeLevelName }}</p>
        <p class="course-title" style="font-size: 0.8rem;"><i class="bi bi-telephone"></i> {{ student.phoneNumber }}</p>
      </div>
    </div>
    }
  </div>

  @if (totalCount > pageSize) {
    <div class="pagination-modern">
      <button class="page-nav" [disabled]="pageIndex === 1" (click)="onPageChange(pageIndex - 1)">
        <i class="bi bi-chevron-left"></i>
      </button>
      @for (p of [].constructor(totalPages); track $index) {
        <button class="page-num" [class.active]="pageIndex === ($index + 1)" (click)="onPageChange($index + 1)">
          {{ $index + 1 }}
        </button>
      }
      <button class="page-nav" [disabled]="pageIndex === totalPages" (click)="onPageChange(pageIndex + 1)">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  }
</div>